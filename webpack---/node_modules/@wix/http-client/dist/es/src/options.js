import {
    __assign
} from "tslib";
import {
    composeHeaders
} from './headers';
import {
    ORIGINAL_HOST_HEADER,
    ORIGINAL_PROTOCOL_HEADER,
    ORIGINAL_URL_HEADER,
} from './constants';
import {
    changeHost,
    extractHost,
    extractProtocol,
    isAbsoluteUrl,
    toSearchQueryParams,
} from './utils';
export var buildOptions = function(_a) {
    var _b;
    var requestOptions = _a.requestOptions,
        _c = _a.urlObject,
        protocol = _c.protocol,
        host = _c.host,
        wixHeadersOpts = _a.wixHeadersOpts,
        _d = _a.globalConfig,
        globalConfig = _d === void 0 ? {
            httpMockServer: {
                enabled: false,
            },
        } : _d;
    var url = requestOptions.url,
        params = requestOptions.params,
        disableWixHeaders = requestOptions.disableWixHeaders,
        headers = requestOptions.headers;
    if (params) {
        if (typeof params !== 'object') {
            throw new Error('Search params must be an object');
        }
    }
    var composedHeaders = composeHeaders({
        url: url,
        disableWixHeaders: disableWixHeaders,
        wixHeadersOpts: wixHeadersOpts,
    });
    var localConfigOptions = maybeRedirectToMockServer(url, globalConfig);
    var originalUrlHeader = globalConfig.httpMockServer.enabled ?
        (_b = {},
            _b[ORIGINAL_URL_HEADER] = buildUrlFromRequest(url, params),
            _b[ORIGINAL_HOST_HEADER] = isAbsoluteUrl(url) ? extractHost(url) : host,
            _b[ORIGINAL_PROTOCOL_HEADER] = isAbsoluteUrl(url) ?
            extractProtocol(url) :
            protocol,
            _b) : {};
    var newOptions = __assign(__assign(__assign({}, requestOptions), localConfigOptions), {
        headers: __assign(__assign(__assign({}, composedHeaders), lowerAllJsonKeys(headers)), originalUrlHeader)
    });
    return newOptions;
};

function maybeRedirectToMockServer(url, globalConfig) {
    if (globalConfig.httpMockServer.enabled) {
        var mockUrl = new URL(globalConfig.httpMockServer.mockServerUrl);
        return {
            url: changeHost(url, mockUrl.host),
        };
    }
    return {};
}

function buildUrlFromRequest(url, requestParams) {
    var _a = new URL(url, 'http://unused.com'),
        pathname = _a.pathname,
        searchParams = _a.searchParams;
    requestParams = requestParams || searchParams;
    if (requestParams) {
        var params = toSearchQueryParams(requestParams) || requestParams.toString();
        var paramsAsString = params ? "?" + params : '';
        return "" + pathname + paramsAsString;
    }
    return pathname;
}

function lowerAllJsonKeys(objectToChange) {
    objectToChange = objectToChange || {};
    var result = Object.keys(objectToChange).reduce(function(prev, key) {
        var _a;
        return (__assign(__assign({}, prev), (_a = {}, _a[key.toLowerCase()] = objectToChange[key], _a)));
    }, {});
    return result;
}
//# sourceMappingURL=options.js.map